<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JetDNS - Initiale Konfiguration</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Flag Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/7.2.3/css/flag-icons.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --success-color: #059669;
            --warning-color: #d97706;
            --danger-color: #dc2626;
        }

        body {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .setup-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .setup-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            max-width: 800px;
            width: 100%;
        }

        .setup-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-align: center;
            padding: 40px 20px;
        }

        .setup-logo {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .setup-content {
            padding: 40px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e5e7eb;
            color: #6b7280;
            margin: 0 10px;
            position: relative;
            font-weight: bold;
        }

        .step.active {
            background-color: var(--primary-color);
            color: white;
        }

        .step.completed {
            background-color: var(--success-color);
            color: white;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            width: 20px;
            height: 2px;
            background-color: #e5e7eb;
            transform: translateY(-50%);
        }

        .step:last-child::after {
            display: none;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .network-preview {
            background: #f8fafc;
            border: 2px dashed #d1d5db;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
        }

        .ip-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ip-octet {
            flex: 1;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 600;
        }

        .btn-outline-primary {
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 600;
        }

        .form-control {
            border-radius: 10px;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
        }

        .alert {
            border-radius: 10px;
            border: none;
            padding: 15px 20px;
        }

        .progress {
            height: 10px;
            border-radius: 5px;
            background-color: #f3f4f6;
        }

        .progress-bar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 5px;
        }

        .language-option {
            cursor: pointer;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .language-option:hover {
            border-color: var(--primary-color);
            background-color: #f8fafc;
        }

        .language-option.selected {
            border-color: var(--primary-color);
            background-color: #eff6ff;
        }

        .feature-list {
            list-style: none;
            padding: 0;
        }

        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .feature-list li:last-child {
            border-bottom: none;
        }

        .feature-list i {
            color: var(--success-color);
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <div class="setup-card">
            <!-- Header -->
            <div class="setup-header">
                <div class="setup-logo">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h1 class="h2 mb-2">Willkommen bei JetDNS</h1>
                <p class="mb-0 opacity-75">Lassen Sie uns Ihren DNS-Server konfigurieren</p>
            </div>

            <div class="setup-content">
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step active" id="step-1">1</div>
                    <div class="step" id="step-2">2</div>
                    <div class="step" id="step-3">3</div>
                    <div class="step" id="step-4">4</div>
                </div>

                <!-- Progress Bar -->
                <div class="progress mb-4">
                    <div class="progress-bar" role="progressbar" style="width: 25%" id="progress-bar"></div>
                </div>

                <!-- Step 1: Sprache -->
                <div class="step-content active" id="content-1">
                    <div class="text-center mb-4">
                        <h3><i class="fas fa-globe me-2"></i>Sprache auswählen</h3>
                        <p class="text-muted">Wählen Sie Ihre bevorzugte Sprache für die Benutzeroberfläche</p>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="language-option selected" data-lang="de">
                                <div class="d-flex align-items-center">
                                    <span class="flag-icon flag-icon-de me-3" style="font-size: 2rem;"></span>
                                    <div>
                                        <h6 class="mb-1">Deutsch</h6>
                                        <small class="text-muted">German</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="language-option" data-lang="en">
                                <div class="d-flex align-items-center">
                                    <span class="flag-icon flag-icon-gb me-3" style="font-size: 2rem;"></span>
                                    <div>
                                        <h6 class="mb-1">English</h6>
                                        <small class="text-muted">English</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Hinweis:</strong> Die Sprache kann später in den Einstellungen geändert werden. Weitere europäische Sprachen sind verfügbar.
                    </div>
                </div>

                <!-- Step 2: Netzwerk-Konfiguration -->
                <div class="step-content" id="content-2">
                    <div class="text-center mb-4">
                        <h3><i class="fas fa-network-wired me-2"></i>Netzwerk-Konfiguration</h3>
                        <p class="text-muted">Konfigurieren Sie die IP-Adresse für Ihren JetDNS Server</p>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label"><strong>Server IP-Adresse</strong></label>
                                <div class="ip-input-group">
                                    <input type="number" class="form-control ip-octet" id="ip1" min="0" max="255" value="192">
                                    <span>.</span>
                                    <input type="number" class="form-control ip-octet" id="ip2" min="0" max="255" value="168">
                                    <span>.</span>
                                    <input type="number" class="form-control ip-octet" id="ip3" min="0" max="255" value="1">
                                    <span>.</span>
                                    <input type="number" class="form-control ip-octet" id="ip4" min="0" max="255" value="76">
                                </div>
                                <div class="form-text">
                                    Diese IP-Adresse wird systemweit als neue Netzwerk-Adresse konfiguriert.
                                    Clients verwenden diese Adresse, um DNS-Anfragen zu stellen.
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label"><strong>DNS Server Port</strong></label>
                                    <input type="number" class="form-control" id="dns_port" value="53" min="1" max="65535">
                                    <div class="form-text">Standard DNS Port (53)</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label"><strong>Aktueller Netzwerkadapter</strong></label>
                                    <select class="form-select" id="network_interface">
                                        <option value="eth0">eth0 - Ethernet</option>
                                        <option value="wlan0">wlan0 - WLAN</option>
                                        <option value="enp0s3">enp0s3 - Virtual Ethernet</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="network-preview">
                                <h6>Vorschau</h6>
                                <div class="mb-2">
                                    <strong>DNS Server:</strong><br>
                                    <span id="preview-ip">192.168.1.76:53</span>
                                </div>
                                <div class="mb-2">
                                    <strong>Client Konfiguration:</strong><br>
                                    <small class="text-muted">DNS: <span id="preview-client-ip">192.168.1.76</span></small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Achtung:</strong> Die IP-Adresse wird permanent im System geändert. 
                        Stellen Sie sicher, dass die gewählte IP-Adresse in Ihrem Netzwerk verfügbar ist.
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <button class="btn btn-outline-info btn-sm w-100" onclick="testNetworkConnection()">
                                <i class="fas fa-network-wired me-1"></i>Verbindung testen
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-secondary btn-sm w-100" onclick="createBackup()">
                                <i class="fas fa-save me-1"></i>Backup erstellen
                            </button>
                        </div>
                    </div>

                    <div id="network-test-result" class="mt-3" style="display: none;"></div>
                    <div id="backup-result" class="mt-3" style="display: none;"></div>
                </div>

                <!-- Step 3: Web-Interface Konfiguration -->
                <div class="step-content" id="content-3">
                    <div class="text-center mb-4">
                        <h3><i class="fas fa-desktop me-2"></i>Web-Interface</h3>
                        <p class="text-muted">Konfigurieren Sie den Zugang zur Verwaltungsoberfläche</p>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label"><strong>Web-Interface Port</strong></label>
                                <input type="number" class="form-control" id="web_port" value="80" min="1" max="65535">
                                <div class="form-text">Port für die Web-Verwaltung</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label"><strong>Protokoll</strong></label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="protocol" id="http" value="http" checked>
                                        <label class="form-check-label" for="http">
                                            <i class="fas fa-globe me-1"></i> HTTP
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="protocol" id="https" value="https">
                                        <label class="form-check-label" for="https">
                                            <i class="fas fa-lock me-1"></i> HTTPS
                                        </label>
                                    </div>
                                </div>
                                <div class="form-text">HTTPS erfordert SSL-Zertifikat (kann später konfiguriert werden)</div>
                            </div>

                            <div class="mb-3" id="https-options" style="display: none;">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="auto_redirect">
                                    <label class="form-check-label" for="auto_redirect">
                                        HTTP zu HTTPS umleiten
                                    </label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="self_signed_cert" checked>
                                    <label class="form-check-label" for="self_signed_cert">
                                        Selbst-signiertes Zertifikat erstellen
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="network-preview">
                                <h6>Web-Interface Zugang</h6>
                                <div class="mb-2">
                                    <strong>URL:</strong><br>
                                    <span id="preview-web-url">http://192.168.1.76:80</span>
                                </div>
                                <div class="mb-2">
                                    <strong>Standard-Benutzer:</strong><br>
                                    <small>admin / setup123</small>
                                </div>
                                <div class="text-muted small">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Passwort nach der ersten Anmeldung ändern
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Zusammenfassung -->
                <div class="step-content" id="content-4">
                    <div class="text-center mb-4">
                        <h3><i class="fas fa-check-circle me-2"></i>Konfiguration abschließen</h3>
                        <p class="text-muted">Überprüfen Sie Ihre Einstellungen und starten Sie JetDNS</p>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Zusammenfassung der Konfiguration</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="feature-list">
                                        <li><i class="fas fa-language"></i> Sprache: <span id="summary-language">Deutsch</span></li>
                                        <li><i class="fas fa-server"></i> Server IP: <span id="summary-ip">192.168.1.76</span></li>
                                        <li><i class="fas fa-network-wired"></i> DNS Port: <span id="summary-dns-port">53</span></li>
                                        <li><i class="fas fa-desktop"></i> Web Port: <span id="summary-web-port">80</span></li>
                                        <li><i class="fas fa-shield-alt"></i> Protokoll: <span id="summary-protocol">HTTP</span></li>
                                        <li><i class="fas fa-ethernet"></i> Interface: <span id="summary-interface">eth0</span></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Nächste Schritte</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="feature-list">
                                        <li><i class="fas fa-cog"></i> Systemkonfiguration wird angewendet</li>
                                        <li><i class="fas fa-network-wired"></i> Netzwerk wird neu konfiguriert</li>
                                        <li><i class="fas fa-rocket"></i> JetDNS Services werden gestartet</li>
                                        <li><i class="fas fa-browser"></i> Web-Interface wird aktiviert</li>
                                        <li><i class="fas fa-shield-alt"></i> Firewall-Regeln werden erstellt</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-success">
                        <i class="fas fa-rocket me-2"></i>
                        <strong>Bereit für den Start!</strong> Nach der Konfiguration erreichen Sie JetDNS unter der neuen IP-Adresse.
                    </div>

                    <!-- Configuration Progress (initially hidden) -->
                    <div id="config-progress" style="display: none;">
                        <h5 class="mt-4">Konfiguration wird angewendet...</h5>
                        <div class="progress mb-2">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" id="config-progress-bar"></div>
                        </div>
                        <div id="config-status" class="text-muted">Initialisierung...</div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-primary" id="prev-btn" onclick="previousStep()" disabled>
                        <i class="fas fa-arrow-left me-2"></i>Zurück
                    </button>

                    <button type="button" class="btn btn-primary" id="next-btn" onclick="nextStep()">
                        Weiter<i class="fas fa-arrow-right ms-2"></i>
                    </button>

                    <button type="button" class="btn btn-success" id="finish-btn" onclick="finishSetup()" style="display: none;">
                        <i class="fas fa-rocket me-2"></i>JetDNS starten
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentStep = 1;
        const totalSteps = 4;
        let selectedLanguage = 'de';

        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function() {
            updatePreview();
            updateSummary();

            // Language selection
            document.querySelectorAll('.language-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.language-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedLanguage = this.getAttribute('data-lang');
                    updateSummary();
                });
            });

            // IP input validation and preview update
            document.querySelectorAll('.ip-octet').forEach(input => {
                input.addEventListener('input', updatePreview);
            });

            // Port and protocol changes
            document.getElementById('dns_port').addEventListener('input', updatePreview);
            document.getElementById('web_port').addEventListener('input', updatePreview);
            document.querySelectorAll('input[name="protocol"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updatePreview();
                    updateSummary();
                    const httpsOptions = document.getElementById('https-options');
                    httpsOptions.style.display = this.value === 'https' ? 'block' : 'none';
                });
            });

            document.getElementById('network_interface').addEventListener('change', updateSummary);
        });

        function updatePreview() {
            const ip1 = document.getElementById('ip1').value || '192';
            const ip2 = document.getElementById('ip2').value || '168';
            const ip3 = document.getElementById('ip3').value || '1';
            const ip4 = document.getElementById('ip4').value || '76';
            const dnsPort = document.getElementById('dns_port').value || '53';
            const webPort = document.getElementById('web_port').value || '80';
            const protocol = document.querySelector('input[name="protocol"]:checked').value;

            const fullIP = `${ip1}.${ip2}.${ip3}.${ip4}`;

            document.getElementById('preview-ip').textContent = `${fullIP}:${dnsPort}`;
            document.getElementById('preview-client-ip').textContent = fullIP;
            document.getElementById('preview-web-url').textContent = `${protocol}://${fullIP}:${webPort}`;
        }

        function updateSummary() {
            const ip1 = document.getElementById('ip1').value || '192';
            const ip2 = document.getElementById('ip2').value || '168';
            const ip3 = document.getElementById('ip3').value || '1';
            const ip4 = document.getElementById('ip4').value || '76';
            const fullIP = `${ip1}.${ip2}.${ip3}.${ip4}`;

            document.getElementById('summary-language').textContent = selectedLanguage === 'de' ? 'Deutsch' : 'English';
            document.getElementById('summary-ip').textContent = fullIP;
            document.getElementById('summary-dns-port').textContent = document.getElementById('dns_port').value || '53';
            document.getElementById('summary-web-port').textContent = document.getElementById('web_port').value || '80';
            document.getElementById('summary-protocol').textContent = document.querySelector('input[name="protocol"]:checked').value.toUpperCase();
            document.getElementById('summary-interface').textContent = document.getElementById('network_interface').value || 'eth0';
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                // Validate current step
                if (!validateStep(currentStep)) {
                    return;
                }

                currentStep++;
                updateStep();
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStep();
            }
        }

        function updateStep() {
            // Update step indicators
            for (let i = 1; i <= totalSteps; i++) {
                const stepElement = document.getElementById(`step-${i}`);
                const contentElement = document.getElementById(`content-${i}`);

                if (i < currentStep) {
                    stepElement.className = 'step completed';
                    contentElement.classList.remove('active');
                } else if (i === currentStep) {
                    stepElement.className = 'step active';
                    contentElement.classList.add('active');
                } else {
                    stepElement.className = 'step';
                    contentElement.classList.remove('active');
                }
            }

            // Update progress bar
            const progressPercent = (currentStep / totalSteps) * 100;
            document.getElementById('progress-bar').style.width = progressPercent + '%';

            // Update navigation buttons
            document.getElementById('prev-btn').disabled = currentStep === 1;

            if (currentStep === totalSteps) {
                document.getElementById('next-btn').style.display = 'none';
                document.getElementById('finish-btn').style.display = 'inline-block';
            } else {
                document.getElementById('next-btn').style.display = 'inline-block';
                document.getElementById('finish-btn').style.display = 'none';
            }

            // Update summary when reaching final step
            if (currentStep === totalSteps) {
                updateSummary();
            }
        }

        function validateStep(step) {
            switch (step) {
                case 2:
                    // Validate IP addresses
                    const octets = ['ip1', 'ip2', 'ip3', 'ip4'];
                    for (let octet of octets) {
                        const value = parseInt(document.getElementById(octet).value);
                        if (isNaN(value) || value < 0 || value > 255) {
                            alert('Bitte geben Sie gültige IP-Adressen ein (0-255).');
                            return false;
                        }
                    }

                    // Validate DNS port
                    const dnsPort = parseInt(document.getElementById('dns_port').value);
                    if (isNaN(dnsPort) || dnsPort < 1 || dnsPort > 65535) {
                        alert('Bitte geben Sie einen gültigen DNS Port ein (1-65535).');
                        return false;
                    }
                    break;

                case 3:
                    // Validate web port
                    const webPort = parseInt(document.getElementById('web_port').value);
                    if (isNaN(webPort) || webPort < 1 || webPort > 65535) {
                        alert('Bitte geben Sie einen gültigen Web Port ein (1-65535).');
                        return false;
                    }
                    break;
            }
            return true;
        }

        function finishSetup() {
            // Show configuration progress
            document.getElementById('finish-btn').style.display = 'none';
            document.getElementById('prev-btn').style.display = 'none';
            document.getElementById('config-progress').style.display = 'block';

            // Collect configuration data
            const config = {
                language: selectedLanguage,
                server_ip: `${document.getElementById('ip1').value}.${document.getElementById('ip2').value}.${document.getElementById('ip3').value}.${document.getElementById('ip4').value}`,
                dns_port: parseInt(document.getElementById('dns_port').value),
                web_port: parseInt(document.getElementById('web_port').value),
                protocol: document.querySelector('input[name="protocol"]:checked').value,
                network_interface: document.getElementById('network_interface').value,
                https_redirect: document.getElementById('auto_redirect')?.checked || false,
                self_signed_cert: document.getElementById('self_signed_cert')?.checked || false
            };

            // Start configuration process
            applyConfiguration(config);
        }

        function applyConfiguration(config) {
            const progressBar = document.getElementById('config-progress-bar');
            const statusText = document.getElementById('config-status');

            let progress = 0;
            const steps = [
                { text: 'Konfigurationsdatei wird erstellt...', delay: 1000 },
                { text: 'Netzwerk-Interface wird konfiguriert...', delay: 2000 },
                { text: 'DNS-Server wird konfiguriert...', delay: 1500 },
                { text: 'Web-Interface wird vorbereitet...', delay: 1000 },
                { text: 'Firewall-Regeln werden angewendet...', delay: 1500 },
                { text: 'Services werden gestartet...', delay: 2000 },
                { text: 'Konfiguration abgeschlossen!', delay: 1000 }
            ];

            function executeStep(stepIndex) {
                if (stepIndex >= steps.length) {
                    // Configuration completed
                    setTimeout(() => {
                        const newUrl = `${config.protocol}://${config.server_ip}:${config.web_port}`;
                        alert(`JetDNS wurde erfolgreich konfiguriert!\n\nSie werden nun zur neuen Adresse weitergeleitet:\n${newUrl}\n\nBenutzername: admin\nPasswort: setup123`);
                        window.location.href = newUrl;
                    }, 1000);
                    return;
                }

                const step = steps[stepIndex];
                statusText.textContent = step.text;
                progress = ((stepIndex + 1) / steps.length) * 100;
                progressBar.style.width = progress + '%';

                // Send configuration to server
                if (stepIndex === 0) {
                    fetch('/api/setup/configure', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(config)
                    }).catch(error => {
                        console.log('Setup configuration sent:', config);
                    });
                }

                setTimeout(() => executeStep(stepIndex + 1), step.delay);
            }

            executeStep(0);
        }

        // Erweiterte Funktionen
        function testNetworkConnection() {
            const ip1 = document.getElementById('ip1').value || '192';
            const ip2 = document.getElementById('ip2').value || '168';
            const ip3 = document.getElementById('ip3').value || '1';
            const ip4 = document.getElementById('ip4').value || '76';
            const serverIp = `${ip1}.${ip2}.${ip3}.${ip4}`;

            const resultDiv = document.getElementById('network-test-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin me-2"></i>Teste Verbindung zu ${serverIp}...
                </div>
            `;

            fetch('/api/setup/test-connection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({server_ip: serverIp})
            })
            .then(response => response.json())
            .then(data => {
                if (data.reachable) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Verbindung erfolgreich! Antwortzeit: ${data.response_time || 'N/A'}ms
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            IP-Adresse nicht erreichbar. Dies ist normal, wenn die IP noch nicht konfiguriert ist.
                        </div>
                    `;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>
                        Fehler beim Testen der Verbindung: ${error.message}
                    </div>
                `;
            });
        }

        function createBackup() {
            const resultDiv = document.getElementById('backup-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin me-2"></i>Erstelle Backup der aktuellen Konfiguration...
                </div>
            `;

            fetch('/api/setup/backup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Backup erfolgreich erstellt:<br>
                            <small class="text-muted">${data.backup_path}</small>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${data.message}
                        </div>
                    `;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>
                        Fehler beim Erstellen des Backups: ${error.message}
                    </div>
                `;
            });
        }

        function validateConfiguration() {
            const config = {
                server_ip: `${document.getElementById('ip1').value}.${document.getElementById('ip2').value}.${document.getElementById('ip3').value}.${document.getElementById('ip4').value}`,
                dns_port: parseInt(document.getElementById('dns_port').value),
                web_port: parseInt(document.getElementById('web_port').value),
                protocol: document.querySelector('input[name="protocol"]:checked').value,
                language: selectedLanguage
            };

            return fetch('/api/setup/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.warnings.length > 0) {
                    const warningMessage = data.warnings.join('\n');
                    return confirm(`Warungen gefunden:\n${warningMessage}\n\nTrotzdem fortfahren?`);
                }
                return true;
            });
        }

        // Überschreibe finishSetup um Validierung hinzuzufügen
        const originalFinishSetup = finishSetup;
        finishSetup = function() {
            validateConfiguration().then(proceed => {
                if (proceed) {
                    originalFinishSetup();
                }
            }).catch(error => {
                console.error('Validierungsfehler:', error);
                originalFinishSetup(); // Fahre im Fehlerfall trotzdem fort
            });
        };

        // Erweiterte Fehlerbehandlung
        window.addEventListener('error', function(e) {
            console.error('JavaScript Fehler:', e.error);
        });

        // Periodische Gesundheitschecks
        function performHealthCheck() {
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    if (data.status !== 'healthy') {
                        console.warn('System-Gesundheitsprobleme erkannt:', data);
                    }
                })
                .catch(error => {
                    console.warn('Gesundheitscheck fehlgeschlagen:', error);
                });
        }

        // Führe alle 30 Sekunden einen Gesundheitscheck durch
        setInterval(performHealthCheck, 30000);
    </script>
</body>
</html>
