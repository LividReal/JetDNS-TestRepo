{% extends "base.html" %}
{% extends "base.html" %}

{% block title %}Dashboard - JetDNS{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="refreshStatus()">
                    <i class="fas fa-sync-alt me-1"></i>Aktualisieren
                </button>
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-cog me-1"></i>Aktionen
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="restartService()">
                            <i class="fas fa-redo me-2"></i>Service neustarten
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="createBackup()">
                            <i class="fas fa-save me-2"></i>Backup erstellen
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{{ url_for('settings') }}">
                            <i class="fas fa-cog me-2"></i>Einstellungen
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Overview -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6">
        <div class="card">
            <div class="card-body stat-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-number text-success" id="queriesTotal">{{ stats.queries_total or 0 }}</div>
                        <div class="stat-label">Queries Gesamt</div>
                    </div>
                    <i class="fas fa-search text-success" style="font-size: 2rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-sm-6">
        <div class="card">
            <div class="card-body stat-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-number text-primary" id="queriesPerSecond">{{ stats.queries_per_second or 0 }}</div>
                        <div class="stat-label">Queries/Sekunde</div>
                    </div>
                    <i class="fas fa-tachometer-alt text-primary" style="font-size: 2rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-sm-6">
        <div class="card">
            <div class="card-body stat-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-number text-info" id="cacheHitRate">{{ stats.cache_hit_rate or 0 }}%</div>
                        <div class="stat-label">Cache Hit Rate</div>
                    </div>
                    <i class="fas fa-database text-info" style="font-size: 2rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-sm-6">
        <div class="card">
            <div class="card-body stat-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-number text-warning" id="blockedQueries">{{ stats.blocked_queries or 0 }}</div>
                        <div class="stat-label">Blockiert</div>
                    </div>
                    <i class="fas fa-shield-alt text-warning" style="font-size: 2rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Status -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-server me-2"></i>System Status</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>DNS Server</h6>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>
                                    <span class="status-indicator status-{{ 'online' if system.dns_status else 'offline' }}"></span>
                                    DNS Service
                                </span>
                                <span class="badge bg-{{ 'success' if system.dns_status else 'danger' }}">
                                    {{ 'Online' if system.dns_status else 'Offline' }}
                                </span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>
                                    <span class="status-indicator status-{{ 'online' if system.web_status else 'offline' }}"></span>
                                    Web Interface
                                </span>
                                <span class="badge bg-{{ 'success' if system.web_status else 'danger' }}">
                                    {{ 'Online' if system.web_status else 'Offline' }}
                                </span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <small class="text-muted">
                                Uptime: {{ system.uptime or 'Unbekannt' }}<br>
                                Listen: {{ config.dns.listen_address }}:{{ config.dns.listen_port }}
                            </small>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h6>Ressourcen</h6>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>RAM Verbrauch</span>
                                <span>{{ system.memory_usage or 0 }} MB</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-info" style="width: {{ system.memory_percentage or 0 }}%"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>CPU Auslastung</span>
                                <span>{{ system.cpu_usage or 0 }}%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-warning" style="width: {{ system.cpu_usage or 0 }}%"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Cache Größe</span>
                                <span>{{ stats.cache_entries or 0 }} Einträge</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-server me-2"></i>Upstream Server</h5>
            </div>
            <div class="card-body">
                {% for server in upstream_servers %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>
                        <span class="status-indicator status-{{ 'online' if server.status else 'offline' }}"></span>
                        {{ server.address }}
                    </span>
                    <small class="text-muted">{{ server.response_time }}ms</small>
                </div>
                {% endfor %}

                <hr>
                <small class="text-muted">
                    Nächster Health Check: {{ next_health_check or 'Unbekannt' }}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Query Statistics Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Query Statistiken (24h)</h5>
            </div>
            <div class="card-body">
                <canvas id="queryChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Letzte DNS Queries</h5>
                    <a href="{{ url_for('logs') }}" class="btn btn-sm btn-outline-primary">
                        Alle Logs anzeigen
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Zeit</th>
                                <th>Domain</th>
                                <th>Client</th>
                                <th>Typ</th>
                                <th>Antwort</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recentQueries">
                            {% for query in recent_queries %}
                            <tr>
                                <td><small>{{ query.timestamp.strftime('%H:%M:%S') }}</small></td>
                                <td>{{ query.domain }}</td>
                                <td><small>{{ query.client_ip }}</small></td>
                                <td><small>{{ query.qtype }}</small></td>
                                <td><small>{{ query.response_time }}ms</small></td>
                                <td>
                                    {% if query.blocked %}
                                        <span class="badge bg-danger">Blockiert</span>
                                    {% elif query.cached %}
                                        <span class="badge bg-info">Cache</span>
                                    {% else %}
                                        <span class="badge bg-success">OK</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Top Domains</h5>
            </div>
            <div class="card-body">
                {% for domain in top_domains %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>{{ domain.name }}</span>
                    <small class="text-muted">{{ domain.count }} Queries</small>
                </div>
                <div class="progress mb-3" style="height: 4px;">
                    <div class="progress-bar" style="width: {{ domain.percentage }}%"></div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Query Statistics Chart
    const ctx = document.getElementById('queryChart').getContext('2d');
    const queryChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ chart_labels | tojson }},
            datasets: [{
                label: 'Queries',
                data: {{ chart_data.queries | tojson }},
                borderColor: 'rgb(37, 99, 235)',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                tension: 0.1
            }, {
                label: 'Blockiert',
                data: {{ chart_data.blocked | tojson }},
                borderColor: 'rgb(220, 38, 38)',
                backgroundColor: 'rgba(220, 38, 38, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });

    // Real-time updates
    function updateDashboard(data) {
        document.getElementById('queriesTotal').textContent = data.queries_total || 0;
        document.getElementById('queriesPerSecond').textContent = data.queries_per_second || 0;
        document.getElementById('cacheHitRate').textContent = (data.cache_hit_rate || 0) + '%';
        document.getElementById('blockedQueries').textContent = data.blocked_queries || 0;

        // Add new query to recent queries table
        if (data.recent_query) {
            const tbody = document.getElementById('recentQueries');
            const newRow = tbody.insertRow(0);
            newRow.innerHTML = `
                <td><small>${new Date().toLocaleTimeString()}</small></td>
                <td>${data.recent_query.domain}</td>
                <td><small>${data.recent_query.client_ip}</small></td>
                <td><small>${data.recent_query.qtype}</small></td>
                <td><small>${data.recent_query.response_time}ms</small></td>
                <td>
                    ${data.recent_query.blocked ? 
                        '<span class="badge bg-danger">Blockiert</span>' :
                        data.recent_query.cached ?
                        '<span class="badge bg-info">Cache</span>' :
                        '<span class="badge bg-success">OK</span>'
                    }
                </td>
            `;

            // Keep only last 10 rows
            if (tbody.rows.length > 10) {
                tbody.deleteRow(tbody.rows.length - 1);
            }
        }
    }

    function refreshStatus() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => updateDashboard(data))
            .catch(error => console.error('Error refreshing status:', error));
    }

    function restartService() {
        if (confirm('DNS Service wirklich neustarten? Dies führt zu kurzen Ausfällen.')) {
            fetch('/api/restart', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Service wird neugestartet...', 'info');
                        setTimeout(refreshStatus, 5000);
                    } else {
                        showToast('Fehler beim Neustart: ' + data.message, 'danger');
                    }
                });
        }
    }

    function createBackup() {
        showToast('Backup wird erstellt...', 'info');
        fetch('/api/backup', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Backup erfolgreich erstellt: ' + data.backup_name, 'success');
                } else {
                    showToast('Backup-Fehler: ' + data.message, 'danger');
                }
            });
    }

    // Auto-refresh every 10 seconds
    setInterval(refreshStatus, 10000);
</script>
{% endblock %}
{% block title %}Dashboard - Advanced DNS Server{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-0">Dashboard</h1>
            <p class="text-muted">Echtzeitübersicht Ihres DNS-Servers</p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title text-white-50 mb-2">
                                <i class="fas fa-search me-2"></i>Anfragen Gesamt
                            </h5>
                            <h2 class="mb-0 text-white" id="queries-total">0</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-search fa-2x opacity-75"></i>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-white-50">
                            <span id="queries-per-minute">0</span> pro Minute
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card danger">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title text-white-50 mb-2">
                                <i class="fas fa-shield-virus me-2"></i>Blockiert
                            </h5>
                            <h2 class="mb-0 text-white" id="queries-blocked">0</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-ban fa-2x opacity-75"></i>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-white-50">
                            <span id="block-rate">0</span>% Blockierungsrate
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card success">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title text-white-50 mb-2">
                                <i class="fas fa-memory me-2"></i>Cache Treffer
                            </h5>
                            <h2 class="mb-0 text-white" id="cache-hits">0</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-tachometer-alt fa-2x opacity-75"></i>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-white-50">
                            <span id="cache-hit-rate">0</span>% Trefferrate
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title text-white-50 mb-2">
                                <i class="fas fa-clock me-2"></i>Antwortzeit
                            </h5>
                            <h2 class="mb-0 text-white" id="response-time">0ms</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-stopwatch fa-2x opacity-75"></i>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-white-50">
                            Durchschnittlich
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-xl-8 col-lg-7 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">DNS-Anfragen Timeline</h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary active" data-period="1h">1h</button>
                        <button class="btn btn-outline-primary" data-period="6h">6h</button>
                        <button class="btn btn-outline-primary" data-period="24h">24h</button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="queries-chart" height="100"></canvas>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-lg-5 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Sicherheitsbewertung</h5>
                </div>
                <div class="card-body text-center">
                    <div class="security-score excellent" id="security-score">85</div>
                    <p class="mb-3">von 100</p>
                    <div class="progress mb-3" style="height: 10px;">
                        <div class="progress-bar bg-success" id="security-progress" style="width: 85%"></div>
                    </div>
                    <p class="text-muted mb-3" id="security-level">Gut</p>

                    <div class="row text-start">
                        <div class="col-6">
                            <small class="text-muted">Bedrohungen heute</small>
                            <div class="fw-bold" id="threats-today">0</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Aktive Filter</small>
                            <div class="fw-bold">5</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Query Types and Top Domains -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Anfrage-Typen</h5>
                </div>
                <div class="card-body">
                    <canvas id="query-types-chart" height="200"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Top Domains</h5>
                    <span class="badge bg-primary" id="unique-domains">0</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Domain</th>
                                    <th class="text-end">Anfragen</th>
                                    <th class="text-end">%</th>
                                </tr>
                            </thead>
                            <tbody id="top-domains-list">
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        <div class="loading-spinner me-2"></div>Lade Daten...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity and System Status -->
    <div class="row mb-4">
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Aktuelle Aktivität</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
                        <label class="form-check-label" for="auto-refresh">Auto-Aktualisierung</label>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Zeit</th>
                                    <th>Client</th>
                                    <th>Domain</th>
                                    <th>Typ</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recent-queries">
                                <tr>
                                    <td colspan="5" class="text-center text-muted">
                                        <div class="loading-spinner me-2"></div>Lade Daten...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">System Status</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>CPU Auslastung</small>
                            <small id="cpu-usage">0%</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" id="cpu-progress" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>RAM Auslastung</small>
                            <small id="memory-usage">0%</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-info" id="memory-progress" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>Aktive Verbindungen</small>
                            <small id="active-connections">0</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>Uptime</small>
                            <small id="uptime">0s</small>
                        </div>
                    </div>

                    <hr>

                    <div class="text-center">
                        <button class="btn btn-primary btn-sm me-2" onclick="flushCache()">
                            <i class="fas fa-broom me-1"></i>Cache leeren
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="testQuery()">
                            <i class="fas fa-search me-1"></i>Test Query
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Query Modal -->
<div class="modal fade" id="testQueryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">DNS Query Test</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="test-query-form">
                    <div class="mb-3">
                        <label for="test-domain" class="form-label">Domain</label>
                        <input type="text" class="form-control" id="test-domain" value="google.com" required>
                    </div>
                    <div class="mb-3">
                        <label for="test-type" class="form-label">Record Type</label>
                        <select class="form-select" id="test-type">
                            <option value="A">A</option>
                            <option value="AAAA">AAAA</option>
                            <option value="MX">MX</option>
                            <option value="TXT">TXT</option>
                            <option value="CNAME">CNAME</option>
                            <option value="NS">NS</option>
                        </select>
                    </div>
                </form>
                <div id="test-result" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
                <button type="button" class="btn btn-primary" onclick="runTestQuery()">
                    <i class="fas fa-play me-1"></i>Test ausführen
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let queriesChart, queryTypesChart;
let currentPeriod = '1h';

document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadDashboardData();

    // Socket events
    socket.on('stats_update', updateStats);
    socket.on('new_query', addRecentQuery);
    socket.on('threat_alert', showThreatAlert);

    // Period selector
    document.querySelectorAll('[data-period]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentPeriod = this.dataset.period;
            updateQueriesChart();
        });
    });

    // Auto-refresh toggle
    document.getElementById('auto-refresh').addEventListener('change', function() {
        if (this.checked) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    });

    startAutoRefresh();
});

function initializeCharts() {
    // Queries Timeline Chart
    const queriesCtx = document.getElementById('queries-chart').getContext('2d');
    queriesChart = new Chart(queriesCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Gesamt',
                    data: [],
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Blockiert',
                    data: [],
                    borderColor: '#dc2626',
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Cache',
                    data: [],
                    borderColor: '#059669',
                    backgroundColor: 'rgba(5, 150, 105, 0.1)',
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            elements: {
                point: {
                    radius: 2,
                    hoverRadius: 4
                }
            }
        }
    });

    // Query Types Chart
    const queryTypesCtx = document.getElementById('query-types-chart').getContext('2d');
    queryTypesChart = new Chart(queryTypesCtx, {
        type: 'doughnut',
        data: {
            labels: ['A', 'AAAA', 'MX', 'TXT', 'CNAME', 'Andere'],
            datasets: [{
                data: [45, 25, 10, 8, 7, 5],
                backgroundColor: [
                    '#2563eb',
                    '#059669',
                    '#d97706',
                    '#dc2626',
                    '#7c3aed',
                    '#6b7280'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
}

function loadDashboardData() {
    // Load initial statistics
    fetch('/api/stats')
        .then(response => response.json())
        .then(updateStats)
        .catch(error => console.error('Error loading stats:', error));

    // Load recent queries
    loadRecentQueries();

    // Load top domains
    loadTopDomains();

    // Load performance metrics
    loadPerformanceMetrics();
}

function updateStats(stats) {
    // Update stat cards
    document.getElementById('queries-total').textContent = formatNumber(stats.queries_total || 0);
    document.getElementById('queries-blocked').textContent = formatNumber(stats.queries_blocked || 0);
    document.getElementById('cache-hits').textContent = formatNumber(stats.queries_cached || 0);

    const responseTime = (stats.average_response_time || 0) * 1000;
    document.getElementById('response-time').textContent = `${responseTime.toFixed(0)}ms`;

    // Update percentages
    document.getElementById('block-rate').textContent = (stats.block_rate || 0).toFixed(1);
    document.getElementById('cache-hit-rate').textContent = (stats.cache_hit_rate || 0).toFixed(1);

    // Update queries per minute (estimated)
    const qpm = Math.round((stats.queries_total || 0) / Math.max(stats.uptime / 60, 1));
    document.getElementById('queries-per-minute').textContent = formatNumber(qpm);

    // Update security score
    if (stats.security_score) {
        updateSecurityScore(stats.security_score);
    }

    // Update system metrics
    updateSystemMetrics(stats);

    updateLastUpdateTime();
}

function updateSecurityScore(securityData) {
    const score = securityData.overall_score || 85;
    const level = securityData.security_level || 'Good';
    const threats = securityData.recent_threats || 0;

    document.getElementById('security-score').textContent = score;
    document.getElementById('security-progress').style.width = `${score}%`;
    document.getElementById('security-level').textContent = level;
    document.getElementById('threats-today').textContent = formatNumber(threats);

    // Update score color
    const scoreElement = document.getElementById('security-score');
    scoreElement.className = 'security-score';

    if (score >= 90) {
        scoreElement.classList.add('excellent');
        document.getElementById('security-progress').className = 'progress-bar bg-success';
    } else if (score >= 75) {
        scoreElement.classList.add('good');
        document.getElementById('security-progress').className = 'progress-bar bg-primary';
    } else if (score >= 60) {
        scoreElement.classList.add('fair');
        document.getElementById('security-progress').className = 'progress-bar bg-warning';
    } else {
        scoreElement.classList.add('poor');
        document.getElementById('security-progress').className = 'progress-bar bg-danger';
    }
}

function updateSystemMetrics(stats) {
    if (stats.performance_metrics) {
        const perf = stats.performance_metrics;

        // CPU Usage
        const cpu = perf.cpu_usage || 0;
        document.getElementById('cpu-usage').textContent = `${cpu.toFixed(1)}%`;
        document.getElementById('cpu-progress').style.width = `${cpu}%`;

        if (cpu > 80) {
            document.getElementById('cpu-progress').className = 'progress-bar bg-danger';
        } else if (cpu > 60) {
            document.getElementById('cpu-progress').className = 'progress-bar bg-warning';
        } else {
            document.getElementById('cpu-progress').className = 'progress-bar bg-success';
        }

        // Memory Usage
        const memory = perf.memory_usage || 0;
        document.getElementById('memory-usage').textContent = `${memory.toFixed(1)}%`;
        document.getElementById('memory-progress').style.width = `${memory}%`;
    }

    // Active connections
    document.getElementById('active-connections').textContent = formatNumber(stats.active_connections || 0);

    // Uptime
    document.getElementById('uptime').textContent = formatDuration(stats.uptime || 0);
}

function loadRecentQueries() {
    fetch('/api/recent_queries?limit=10')
        .then(response => response.json())
        .then(queries => {
            const tbody = document.getElementById('recent-queries');
            if (queries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Keine Daten verfügbar</td></tr>';
                return;
            }

            tbody.innerHTML = queries.map(query => {
                const statusBadge = getStatusBadge(query.status);
                const time = new Date(query.timestamp).toLocaleTimeString('de-DE');

                return `
                    <tr class="log-entry ${query.status}">
                        <td><small>${time}</small></td>
                        <td><small>${query.client_ip}</small></td>
                        <td>
                            <small>${query.domain}</small>
                            ${query.threat_level ? `<i class="fas fa-exclamation-triangle text-warning ms-1" title="Bedrohung erkannt"></i>` : ''}
                        </td>
                        <td><span class="badge badge-custom bg-secondary">${query.type}</span></td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        })
        .catch(error => {
            console.error('Error loading recent queries:', error);
            document.getElementById('recent-queries').innerHTML = 
                '<tr><td colspan="5" class="text-center text-danger">Fehler beim Laden</td></tr>';
        });
}

function loadTopDomains() {
    fetch('/api/top_domains?limit=10')
        .then(response => response.json())
        .then(domains => {
            const tbody = document.getElementById('top-domains-list');

            if (domains.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Keine Daten verfügbar</td></tr>';
                return;
            }

            const total = domains.reduce((sum, domain) => sum + domain.count, 0);

            tbody.innerHTML = domains.map(domain => {
                const percentage = ((domain.count / total) * 100).toFixed(1);
                return `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div>
                                    <div class="fw-bold">${domain.domain}</div>
                                    <small class="text-muted">${domain.category || 'Unbekannt'}</small>
                                </div>
                            </div>
                        </td>
                        <td class="text-end">${formatNumber(domain.count)}</td>
                        <td class="text-end">
                            <div class="d-flex align-items-center justify-content-end">
                                <div class="progress me-2" style="width: 50px; height: 8px;">
                                    <div class="progress-bar" style="width: ${percentage}%"></div>
                                </div>
                                <small>${percentage}%</small>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Update unique domains count
            document.getElementById('unique-domains').textContent = formatNumber(domains.length);
        })
        .catch(error => {
            console.error('Error loading top domains:', error);
            document.getElementById('top-domains-list').innerHTML = 
                '<tr><td colspan="3" class="text-center text-danger">Fehler beim Laden</td></tr>';
        });
}

function loadPerformanceMetrics() {
    fetch('/api/performance_metrics')
        .then(response => response.json())
        .then(metrics => {
            updateSystemMetrics({performance_metrics: metrics});
        })
        .catch(error => console.error('Error loading performance metrics:', error));
}

function getStatusBadge(status) {
    const badges = {
        'allowed': '<span class="badge bg-success">Erlaubt</span>',
        'blocked': '<span class="badge bg-danger">Blockiert</span>',
        'cached': '<span class="badge bg-info">Cache</span>',
        'threat': '<span class="badge bg-warning">Bedrohung</span>',
        'redirected': '<span class="badge bg-primary">Umgeleitet</span>'
    };

    return badges[status] || '<span class="badge bg-secondary">Unbekannt</span>';
}

function addRecentQuery(queryData) {
    const tbody = document.getElementById('recent-queries');
    const existingRows = tbody.querySelectorAll('tr');

    // Remove loading message if present
    if (existingRows.length === 1 && existingRows[0].textContent.includes('Lade Daten')) {
        tbody.innerHTML = '';
    }

    // Create new row
    const statusBadge = getStatusBadge(queryData.status);
    const time = new Date(queryData.timestamp).toLocaleTimeString('de-DE');

    const newRow = document.createElement('tr');
    newRow.className = `log-entry ${queryData.status}`;
    newRow.innerHTML = `
        <td><small>${time}</small></td>
        <td><small>${queryData.client_ip}</small></td>
        <td>
            <small>${queryData.domain}</small>
            ${queryData.threat_level ? `<i class="fas fa-exclamation-triangle text-warning ms-1" title="Bedrohung erkannt"></i>` : ''}
        </td>
        <td><span class="badge badge-custom bg-secondary">${queryData.type}</span></td>
        <td>${statusBadge}</td>
    `;

    // Add to top
    tbody.insertBefore(newRow, tbody.firstChild);

    // Keep only last 10 rows
    while (tbody.children.length > 10) {
        tbody.removeChild(tbody.lastChild);
    }

    // Highlight new row
    newRow.style.backgroundColor = 'rgba(37, 99, 235, 0.1)';
    setTimeout(() => {
        newRow.style.backgroundColor = '';
    }, 2000);
}

function showThreatAlert(threatData) {
    showToast(`Bedrohung erkannt: ${threatData.domain} (${threatData.threat_type})`, 'warning');
}

let autoRefreshInterval;

function startAutoRefresh() {
    if (autoRefreshInterval) return;

    autoRefreshInterval = setInterval(() => {
        if (document.getElementById('auto-refresh').checked) {
            loadDashboardData();
        }
    }, 30000); // 30 seconds
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

function updateQueriesChart() {
    // Update chart data based on selected period
    // This would fetch data from the API based on the selected time period
    fetch(`/api/query_timeline?period=${currentPeriod}`)
        .then(response => response.json())
        .then(data => {
            queriesChart.data.labels = data.labels;
            queriesChart.data.datasets[0].data = data.total;
            queriesChart.data.datasets[1].data = data.blocked;
            queriesChart.data.datasets[2].data = data.cached;
            queriesChart.update();
        })
        .catch(error => console.error('Error updating queries chart:', error));
}

function flushCache() {
    if (confirm('Sind Sie sicher, dass Sie den DNS-Cache leeren möchten?')) {
        fetch('/api/flush_cache', {method: 'POST'})
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('Cache erfolgreich geleert', 'success');
                } else {
                    showToast('Fehler beim Leeren des Cache', 'error');
                }
            })
            .catch(error => {
                console.error('Error flushing cache:', error);
                showToast('Fehler beim Leeren des Cache', 'error');
            });
    }
}

function testQuery() {
    const modal = new bootstrap.Modal(document.getElementById('testQueryModal'));
    modal.show();
}

function runTestQuery() {
    const domain = document.getElementById('test-domain').value;
    const type = document.getElementById('test-type').value;
    const resultDiv = document.getElementById('test-result');

    if (!domain) {
        resultDiv.innerHTML = '<div class="alert alert-danger">Bitte geben Sie eine Domain ein</div>';
        return;
    }

    resultDiv.innerHTML = '<div class="text-center"><div class="loading-spinner me-2"></div>Test läuft...</div>';

    fetch('/api/test_query', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({domain, type})
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6>Test erfolgreich</h6>
                    <p><strong>Domain:</strong> ${result.domain}</p>
                    <p><strong>Antwortzeit:</strong> ${(result.response_time * 1000).toFixed(0)}ms</p>
                    <p><strong>Antworten:</strong></p>
                    <ul class="mb-0">
                        ${result.answers.map(answer => `<li><code>${answer}</code></li>`).join('')}
                    </ul>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6>Test fehlgeschlagen</h6>
                    <p><strong>Fehler:</strong> ${result.error}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error running test query:', error);
        resultDiv.innerHTML = '<div class="alert alert-danger">Fehler beim Ausführen des Tests</div>';
    });
}
</script>
{% endblock %}
